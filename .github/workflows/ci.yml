name: CI

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:
    branches: ["*"]

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]
        gate: ["gate_t", "gate_aj", "gate_s", "gate_p", "gate_o", "gate_ah", "gate_ops", "gate_obs", "chaos"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .
      - name: Pre-gate — Clock drift guard
        run: python -m jobs.clock_guard --max-skew-sec 5
      - name: Run pytest (gate)
        run: |
          pytest -q -m ${{ matrix.gate }} --ignore vendor --ignore kai-decisionos

  release_gate:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .
      - name: Prepare release evidence
        run: |
          mkdir -p var/evidence reports
          cp evidence/sample_release_gate.json var/evidence/latest.json
      - name: Build shadow/canary sample
        run: |
          python -m apps.cli.dosctl.shadow_capture --out var/shadow --samples 20000
          python -m apps.cli.dosctl.canary_compare \
            --control var/shadow/control.csv \
            --canary var/shadow/canary.csv \
            --out var/evidence/canary-latest.json
      - name: Harvest reqlog sample
        run: |
          python jobs/evidence_harvest_reqlog.py \
            --reqlog data/reqlog_sample.csv \
            --out-json var/evidence/perf-latest.json \
            --evidence var/evidence/latest.json
      - name: Harvest judgelog sample
        run: |
          python jobs/evidence_harvest_judgelog.py \
            --judgelog data/judge_reqlog_sample.csv \
            --out-json var/evidence/perf-judge-latest.json \
            --evidence var/evidence/latest.json \
            --canary-json var/evidence/canary-latest.json
      - name: Build Evidence Index
        run: |
          python -m jobs.evidence_indexer --root var/evidence --out var/evidence/index.json
      - name: Evidence GC (dry-run)
        run: |
          python -m jobs.evidence_gc --root var/evidence --dry-run
      - name: Optimize label weights (dry-run) - s-round
        run: |
          mkdir -p var/evidence/index var/optimizer
          echo '{"infra":{"incidents":2,"cost":1.0},"perf":{"incidents":1,"cost":0.5},"quota":{"incidents":0,"cost":0.1}}' > var/evidence/index/group_stats.json
          python -m jobs.optimize_label_weights \
            --catalog configs/labels/label_catalog.v2.json \
            --index-stats var/evidence/index/group_stats.json \
            --out var/optimizer/weights_suggestion.json || true
      - name: Prepare history for bootstrap - t1-round
        run: |
          mkdir -p var/evidence/index
          echo '{"infra":{"incidents":[2,3,4,3,2],"cost":[1.0,1.1,0.9]},"perf":{"incidents":[1,1,2,1],"cost":[0.2,0.3,0.25]},"quota":{"incidents":[0,0,1],"cost":[0.1,0.15,0.1]}}' > var/evidence/index/history.json
      - name: AB simulate with CI - t1-round
        run: |
          mkdir -p var/optimizer var/sandbox
          python -m jobs.simulate_weights_ab \
            --catalog configs/labels/label_catalog.v2.json \
            --history var/evidence/index/history.json \
            --candidate var/optimizer/weights_suggestion.json \
            --out var/optimizer/ab_report.json \
            --commit-sandbox \
            --iters 200 || true
      - name: Evidence Integrity Check (v0.5.11r-6)
        run: |
          python scripts/ops/evidence_lockdown.py --verify --root var/evidence
      - name: ETag Store Health Check (v0.5.11r-1)
        env:
          DECISIONOS_ETAG_BACKEND: memory
          DECISIONOS_ALLOW_SCOPES: ops:read
        run: |
          python -c "from apps.ops.cache.etag_store import build_etag_store; store = build_etag_store(); print('ETag backend:', type(store).__name__)"
      - name: Prepare local providers
        run: |
          mkdir -p var
          echo 'providers:' > var/providers-local.yaml
          echo '  - id: local-a' >> var/providers-local.yaml
          echo '    type: local' >> var/providers-local.yaml
      - name: Run Gates (infra & canary)
        id: gates
        run: |
          set +e
          python -m apps.cli.dosctl.judge_quorum \
            --slo configs/slo/slo-judge-infra.json \
            --evidence var/evidence/latest.json \
            --providers var/providers-local.yaml \
            --quorum 2/3 --attach-evidence
          if [ $? -ne 0 ]; then echo "INFRA_FAIL=1" >> $GITHUB_OUTPUT; fi
          python -m apps.cli.dosctl.judge_quorum \
            --slo configs/slo/slo-canary.json \
            --evidence var/evidence/latest.json \
            --providers var/providers-local.yaml \
            --quorum 2/3 --attach-evidence
          if [ $? -ne 0 ]; then echo "CANARY_FAIL=1" >> $GITHUB_OUTPUT; fi
          exit 0
      - name: Build Reason Trend (7d)
        run: |
          python -m jobs.reason_trend_daily --days 7 --topK 10 --out var/reports
      - name: Compose Artifact Links
        run: |
          python scripts/ci/compose_artifacts.py
      - name: Strict SLO Gate
        env:
          DECISIONOS_ALLOW_SCOPES: judge:run
        run: |
          python -m apps.cli.dosctl.slo_judge \
            --slo configs/slo/slo-billing-strict-v2.json \
            --evidence var/evidence/latest.json
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-${{ github.run_id }}
          path: |
            var/evidence/*.json
            var/reports/**/*.json
            reports/**/*.xml
            var/rollout/**
            var/optimizer/*.json
            var/sandbox/*.json
      - name: Reconcile canary vs offline - t1-round
        run: |
          mkdir -p var/canary
          echo '{"delta":{"score_delta":0.5}}' > var/canary/compare.json
          python -m jobs.reconcile_canary_vs_offline \
            --ab-report var/optimizer/ab_report.json \
            --canary var/canary/compare.json \
            --out var/optimizer/reconcile_report.json || true
      - name: Label Sync (dry-run) - o-round v2
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          python scripts/ensure_labels.py --repo "${{ github.repository }}" \
            --catalog configs/labels/label_catalog.v2.json --dry-run
      - name: Annotate PR (v5) - o-round
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/annotate_release_gate.py \
            --repo "${{ github.repository }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --evidence var/evidence/latest.json \
            --catalog configs/labels/label_catalog.v2.json \
            --diff-link "https://github.com/${{ github.repository }}/compare/${{ github.base_ref }}...${{ github.head_ref }}" \
            --artifacts-json '{"evidence":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
      - name: Label PR Top Impact
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m scripts.ci.label_top_impact \
            --trend var/reports/reason_trend.json \
            --topK 3
      - name: Summarize Hardening
        if: always()
        run: |
          COUNT=$(python scripts/ci/count_evidence.py)
          {
            echo "### v0.5.11r — Release Hardening ✅"
            echo "- ✅ ETag 인프라 (Redis 폴백)"
            echo "- ✅ 백프레셔 정책 (토큰버킷, 서킷브레이커)"
            echo "- ✅ SLO 재보정 (7일 실측)"
            echo "- ✅ 카나리 튜닝 (5연속, 버스트≤1)"
            echo "- ✅ RBAC default-deny"
            echo "- ✅ Evidence 불변성 (SHA256, ObjectLock)"
            echo "- ✅ DR/Chaos 리허설 (쿼럼 퇴화)"
            echo "- ✅ 키 로테이션 (active→grace→retired)"
            echo "- ✅ 상한선 가시화 (Ops Cards)"
            echo "- ✅ 30분 온콜 드릴 런북"
            echo ""
            echo "Evidence index entries: $COUNT"
            echo "Clock guard: ✅ executed"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Fail if gate failed
        if: steps.gates.outputs.INFRA_FAIL == '1' || steps.gates.outputs.CANARY_FAIL == '1'
        run: exit 1

  e2e_promote:
    runs-on: ubuntu-latest
    needs: release_gate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .
      
      - name: Promote smoke test
        env:
          DECISIONOS_ENFORCE_RBAC: "0"
          DECISIONOS_CONTROLLER_HOOK: "python -m apps.experiment.controller_hook"
        run: |
          bash pipeline/release/promote.sh
      
      - name: Run E2E tests
        run: |
          pytest -q -m e2e tests/e2e/
      
      - name: Upload rollout artifacts
        uses: actions/upload-artifact@v4
        with:
          name: decisionos-rollout-run
          path: |
            var/rollout/**
            var/evidence/**
          if-no-files-found: warn
      
      - name: Summarize
        run: |
          echo "### DecisionOS Promote E2E" >> "${GITHUB_STEP_SUMMARY}"
          echo "- artifacts uploaded" >> "${GITHUB_STEP_SUMMARY}"
          if [ -f var/rollout/desired_stage.txt ]; then
            STAGE=$(cat var/rollout/desired_stage.txt)
            echo "- stage: ${STAGE}" >> "${GITHUB_STEP_SUMMARY}"
          fi
