name: CI

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:
    branches: ["*"]

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]
        gate: ["gate_t", "gate_aj", "gate_s", "gate_p", "gate_o"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .
      - name: Pre-gate — Clock drift guard
        run: python -m jobs.clock_guard --max-skew-sec 5
      - name: Run pytest (gate)
        run: |
          pytest -q -m ${{ matrix.gate }} --ignore vendor --ignore kai-decisionos

  release_gate:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .
      - name: Prepare release evidence
        run: |
          mkdir -p var/evidence reports
          cp evidence/sample_release_gate.json var/evidence/latest.json
      - name: Build shadow/canary sample
        run: |
          python -m apps.cli.dosctl.shadow_capture --out var/shadow --samples 20000
          python -m apps.cli.dosctl.canary_compare \
            --control var/shadow/control.csv \
            --canary var/shadow/canary.csv \
            --out var/evidence/canary-latest.json
      - name: Harvest reqlog sample
        run: |
          python jobs/evidence_harvest_reqlog.py \
            --reqlog data/reqlog_sample.csv \
            --out-json var/evidence/perf-latest.json \
            --evidence var/evidence/latest.json
      - name: Harvest judgelog sample
        run: |
          python jobs/evidence_harvest_judgelog.py \
            --judgelog data/judge_reqlog_sample.csv \
            --out-json var/evidence/perf-judge-latest.json \
            --evidence var/evidence/latest.json \
            --canary-json var/evidence/canary-latest.json
      - name: Build Evidence Index
        run: |
          python -m jobs.evidence_indexer --root var/evidence --out var/evidence/index.json
      - name: Evidence GC (dry-run)
        run: |
          python -m jobs.evidence_gc --root var/evidence --dry-run
      - name: Prepare local providers
        run: |
          mkdir -p var
          cat <<'EOF' > var/providers-local.yaml
providers:
  - id: local-a
    type: local
EOF
      - name: Run Gates (infra & canary)
        id: gates
        run: |
          set +e
          python -m apps.cli.dosctl.judge_quorum \
            --slo configs/slo/slo-judge-infra.json \
            --evidence var/evidence/latest.json \
            --providers var/providers-local.yaml \
            --quorum 2/3 --attach-evidence
          if [ $? -ne 0 ]; then echo "INFRA_FAIL=1" >> $GITHUB_OUTPUT; fi
          python -m apps.cli.dosctl.judge_quorum \
            --slo configs/slo/slo-canary.json \
            --evidence var/evidence/latest.json \
            --providers var/providers-local.yaml \
            --quorum 2/3 --attach-evidence
          if [ $? -ne 0 ]; then echo "CANARY_FAIL=1" >> $GITHUB_OUTPUT; fi
          exit 0
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-${{ github.run_id }}
          path: |
            var/evidence/*.json
            reports/**/*.xml
            var/rollout/**
      - name: Annotate PR
        if: always()
        run: |
          python scripts/ci/annotate_release_gate.py \
            --evidence var/evidence/latest.json \
            --infra-fail "${{ steps.gates.outputs.INFRA_FAIL }}" \
            --canary-fail "${{ steps.gates.outputs.CANARY_FAIL }}"
      - name: Summarize Hardening
        if: always()
        run: |
          COUNT=$(python - <<'PY'
import json
from pathlib import Path
try:
    data = json.loads(Path("var/evidence/index.json").read_text())
    print(data.get("count", 0))
except Exception:
    print("n/a")
PY
)
          {
            echo "### v0.5.11m — Immutability/Chaos/Clock ✅"
            echo "- clock guard executed"
            echo "- evidence index entries: $COUNT"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Fail if gate failed
        if: steps.gates.outputs.INFRA_FAIL == '1' || steps.gates.outputs.CANARY_FAIL == '1'
        run: exit 1

  e2e_promote:
    runs-on: ubuntu-latest
    needs: release_gate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .
      
      - name: Promote smoke test
        env:
          DECISIONOS_ENFORCE_RBAC: "0"
          DECISIONOS_CONTROLLER_HOOK: "python -m apps.experiment.controller_hook"
        run: |
          bash pipeline/release/promote.sh
      
      - name: Run E2E tests
        run: |
          pytest -q -m e2e tests/e2e/
      
      - name: Upload rollout artifacts
        uses: actions/upload-artifact@v4
        with:
          name: decisionos-rollout-run
          path: |
            var/rollout/**
            var/evidence/**
          if-no-files-found: warn
      
      - name: Summarize
        run: |
          echo "### DecisionOS Promote E2E" >> "${GITHUB_STEP_SUMMARY}"
          echo "- artifacts uploaded" >> "${GITHUB_STEP_SUMMARY}"
          if [ -f var/rollout/desired_stage.txt ]; then
            STAGE=$(cat var/rollout/desired_stage.txt)
            echo "- stage: ${STAGE}" >> "${GITHUB_STEP_SUMMARY}"
          fi
