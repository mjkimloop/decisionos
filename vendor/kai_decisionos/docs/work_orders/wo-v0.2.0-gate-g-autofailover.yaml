meta:
  version: v0.2.0
  date: 2025-11-02
  status: locked
  summary: "Gate‑G: Auto‑Failover·프로브·에러버짓 SLO·카나리·카오스 드릴 (No‑Gemini)"

work:
  codex:
    - id: X-29
      title: Probes & Degrade Hooks
      deliverables:
        - apps/gateway/routers/probes.py (/healthz,/readyz,/livez)
        - apps/region/degrade.py (의존성별 게이트)
      acceptance:
        - 의존성 다운 시 기대 동작, 단위테스트 12+
    - id: X-30
      title: Auto‑Failover Controller
      deliverables:
        - apps/region/auto_failover.py (watcher/promoter)
        - scripts/promote_standby.sh
        - scripts/fence_old_primary.sh
      acceptance:
        - 드라이런 2회 RTO≤20m, split‑brain 0
    - id: X-31
      title: Circuit Breaker & Retry Budgets
      deliverables:
        - apps/executor/resilience.py (CB, 백오프, 예산)
        - switchboard 라우터 연동
      acceptance:
        - 타임아웃/실패 시 일시 차단, 예산 소진 시 폴백
    - id: X-32
      title: Canary Router & Admin API
      deliverables:
        - apps/gateway/routers/admin_canary.py
        - apps/feature_flags/store.py (파일/메모리)
      acceptance:
        - percent/tenant 기반 분배, 임계치 초과 시 자동 롤백 훅
    - id: X-33
      title: Chaos/Drill Scripts & Simulators
      deliverables:
        - scripts/chaos_net.sh, scripts/chaos_kill.sh, scripts/drill_failover.sh
        - tests/test_failover_drill.py
      acceptance:
        - 시뮬레이터 통과, 로그/타임라인 산출
    - id: P-05
      title: dosctl 확장(probes/canary/drill)
      deliverables:
        - cli/dosctl/main.py: "probes status"
        - cli/dosctl/main.py: "canary set|status"
        - cli/dosctl/main.py: "drill failover --dry-run"
      acceptance:
        - 로컬에서 엔드투엔드 리허설 자동화

risks:
  - name: split‑brain 위험
    mitigation: 펜싱 스크립트 선행, router flag 갱신 전 old‑primary 차단
  - name: 카나리 중 성능 저하
    mitigation: percent 단계 완화(1→3→10→25→100), 에러버짓 가드
  - name: 오탐/과도한 failover
    mitigation: 연속 n회 실패 기준 + 쿨다운 타이머

patches:
  techspec:
    - section: "Probes"
      mode: replace
      content: |
        프로브(v0.2.0):
        - /healthz: 종합 헬스(의존성 가중치 적용)
        - /readyz: 트래픽 수신 가능 여부(디그레이드 게이트 반영)
        - /livez: 프로세스 생존 여부(경량)
        - 디그레이드 훅: apps/region/degrade.py — 의존성별 차단/완화 정책
    - section: "Auto‑Failover"
      mode: replace
      content: |
        자동 Failover(v0.2.0):
        - Watcher/Promoter: apps/region/auto_failover.py (promote/fence 시나리오)
        - 스크립트: scripts/promote_standby.sh, scripts/fence_old_primary.sh
        - 목표: RTO ≤ 20m, split‑brain 0, 라우터 플래그 동기화
    - section: "SLO & Error Budgets"
      mode: replace
      content: |
        에러버짓 정책(v0.2.0):
        - 소진 50%: 변경 동결, 80%: 카나리 롤백, 100%: 릴리스 금지
        - /decide p95<800ms(모델 미호출), 오류율<1% 준수
    - section: "Canary"
      mode: replace
      content: |
        카나리 롤아웃(v0.2.0):
        - 분배: percent/tenant 기반(1→3→10→25→100)
        - 임계치 초과 시 자동 롤백 훅(Feature Flags 연동)
        - Admin API: /api/v1/admin/canary/*
    - section: "Chaos & Drills"
      mode: replace
      content: |
        카오스/DR 드릴(v0.2.0):
        - 네트워크/프로세스/Failover 시나리오 스크립트 3종
        - 주간/월간 계획 수립 및 리포트 산출(타임라인/로그)
    - section: "Interfaces"
      mode: append
      content: |
        Gate‑G 신규 엔드포인트:
        - GET /healthz, GET /readyz, GET /livez
        - POST /api/v1/admin/canary/set, GET /api/v1/admin/canary/status
  plan:
    - section: "Milestones"
      mode: replace
      content: |
        - Gate‑G: Auto‑Failover·프로브·에러버짓 SLO·카나리·카오스 드릴 도입
    - section: "Next Actions"
      mode: replace
      content: |
        Day 31: 프로브 3종 + 디그레이드 훅 통합
        Day 32: Auto‑Failover 컨트롤러 드라이런(2회)
        Day 33: Circuit Breaker/Retry Budget 연동
        Day 34: Canary Router/관리 API 구성 + 롤백 훅
        Day 35: Chaos/DR 드릴 시뮬레이터 + 리포트 산출

