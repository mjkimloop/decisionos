meta:
  version: v0.5.11u-15d
  date: 2025-11-19
  status: locked
  summary: "Evidence GC 설정 v2 전환: ConfigDict 추가 및 호환성 테스트"
  priority: medium
  owner: platform-team
  reviewers:
    - backend-team
  dependencies:
    - v0.5.11u-15a

scope:
  modules:
    - apps/obs/evidence/gc_config.py
  tests:
    - tests/evidence/test_gc_config_v2_compat_v1.py

---

## Objective
Evidence GC (Garbage Collection) 설정 모델을 Pydantic v2로 전환하여 단계적 마이그레이션 완료.

## Context
- **Phase 4 (Final)** of Pydantic v2 migration (u-15 series)
- GC 설정은 Pydantic을 사용하지만 v2 ConfigDict가 없음
- 2개 모델에 v2 호환성 추가 필요

## Deliverables

### 1. Pydantic v2 ConfigDict 추가 (`apps/obs/evidence/gc_config.py`)
```python
# 모든 GC 모델에 ConfigDict 추가:
if PYDANTIC_V2:
    model_config = ConfigDict(extra='forbid')

# 업데이트된 모델 (2개):
- ObjectLockCfg: S3 Object Lock 설정
  - enabled: bool (기본 True)
  - retention_days: int (기본 365)
  - s3_bucket: Optional[str]
  - s3_prefix: Optional[str]

- GCCfg: Evidence GC 설정
  - retention_days: Dict[str, int] (기본 {"WIP": 7, "LOCKED": 365})
  - keep_min_per_tenant: int (기본 5)
  - exclude_globs: List[str] (기본 ["**/*locked.json"])
  - dry_run: bool (기본 True)
  - object_lock: ObjectLockCfg (중첩 모델)
```

### 2. ConfigDict 설정
```python
# extra='forbid': 알 수 없는 필드 거부 (v2)
# GC 설정 파일의 오타를 조기 발견
model_config = ConfigDict(extra='forbid')
```

### 3. 호환성 테스트 (`tests/evidence/test_gc_config_v2_compat_v1.py`)
```python
# 12개 테스트 (all passing):
- test_object_lock_cfg_defaults: ObjectLockCfg 기본값
- test_object_lock_cfg_custom: ObjectLockCfg 커스텀 값
- test_gc_cfg_defaults: GCCfg 기본값
- test_gc_cfg_custom_retention: retention_days 커스텀
- test_gc_cfg_custom_exclude_globs: exclude_globs 커스텀
- test_gc_cfg_nested_object_lock: 중첩 ObjectLockCfg
- test_gc_cfg_model_validate: v1/v2 호환성
- test_gc_cfg_to_dict: 직렬화
- test_gc_cfg_extra_fields_forbidden: extra='forbid' 검증 (GCCfg)
- test_object_lock_cfg_extra_fields_forbidden: extra='forbid' 검증 (ObjectLockCfg)
- test_gc_cfg_retention_days_type: retention_days Dict 타입
- test_gc_cfg_object_lock_default_instance: 기본 ObjectLockCfg 인스턴스
```

## Test Results
```
✅ 57/57 tests passing (100%)
  - 24 tests: Pydantic compat layer (u-15a)
  - 6 tests: Cards API contracts (u-15b)
  - 15 tests: SLO schema v2 compat (u-15c)
  - 12 tests: Evidence GC config v2 compat (u-15d) ⬅️ NEW

Execution time: ~0.85s (GC tests only)
```

## GC 로직 안정성 보장
- ✅ GC 로직 변경 없음
- ✅ 모든 기존 GC 설정 파일과 호환
- ✅ extra='forbid'로 설정 파일 오타 조기 발견
- ✅ v1/v2 투명 전환 (pydantic_compat 사용)

## Files Changed
```
M  apps/obs/evidence/gc_config.py           (2개 모델에 ConfigDict 추가, docstring 추가)
A  tests/evidence/test_gc_config_v2_compat_v1.py  (12 tests)
A  docs/work_orders/wo-v0.5.11u-15d-evidence-gc-config-v2.yaml
M  CHANGELOG.md
```

## Migration Impact
- **Zero breaking changes**: GC 로직 동일
- **Extra validation**: v2에서 알 수 없는 필드 거부
- **Type safety improved**: ConfigDict로 엄격한 스키마 검증
- **Performance impact**: Negligible

## Rollback Procedure
```bash
# If schema validation causes issues:
git revert v0.5.11u-15d
pytest tests/evidence/  # Verify rollback

# Or temporarily disable extra validation:
# In gc_config.py:
model_config = ConfigDict(extra='ignore')  # Instead of 'forbid'
```

## Series Summary
Pydantic v2 마이그레이션 시리즈 (u-15a ~ u-15d) 완료:
- ✅ u-15a: 공통 호환 레이어 (24 tests)
- ✅ u-15b: Ops/Gateway 스키마 (6 tests)
- ✅ u-15c: Judge/SLO 스키마 (15 tests)
- ✅ u-15d: Evidence GC 설정 (12 tests)

**Total: 57 tests, 100% passing**

## Notes
- 모든 GC 모델에 한글 docstring 추가 (가독성 향상)
- extra='forbid'로 GC 설정 파일의 오타 조기 발견
- GC 로직 (gc.py, indexer.py) 변경 불필요
- 기존 GC 설정 YAML 파일과 100% 호환

---
**Acceptance Criteria:**
- [x] All 12 GC config tests pass
- [x] All models have ConfigDict (v2)
- [x] No breaking changes to GC logic
- [x] All existing tests pass (57/57)

**Signed-off:** Claude (2025-11-19)
