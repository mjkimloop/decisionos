meta:
  version: v0.5.11h
  date: 2025-11-10
  status: locked
  summary: "Gate-T 성능 증빙(p50/p95/p99, error_rate) + Evidence.perf + SLO(latency/error) + Judge 확장 + CLI"

patches:
  techspec:
    - section: "Gate-T — Performance Witness v1"
      mode: upsert
      content: |
        입력: reqlog CSV (컬럼: ts, status, latency_ms)
        산출: PerfSummary {p50, p95, p99, error_rate, count, window:{start,end}}
        모듈:
          - apps/obs/witness/perf.py
            - parse_reqlog_csv(f) -> List[Req]
            - summarize_perf(reqs) -> Dict[p50,p95,p99,error_rate,count,window]
          - apps/cli/dosctl/witness_perf.py
            - dosctl witness perf --csv <path> --out var/evidence/perf-latest.json
    - section: "Evidence — perf block"
      mode: upsert
      content: |
        Evidence.perf 예시:
        {
          "latency_ms": {"p50": 320, "p95": 900, "p99": 1500},
          "error_rate": 0.012,
          "count": 12450,
          "window": {"start": "...", "end": "..."}
        }
        build_snapshot()는 perf 인자 제공 시 perf 블록 병합.
    - section: "SLO-as-Code — Latency & Error"
      mode: upsert
      content: |
        slo_schema 확장:
          - SLOLatency {max_p95_ms:int|null, max_p99_ms:int|null}
          - SLOError {max_error_rate: float|null}
        평가 규칙:
          - perf 누락 시 fail-closed (latency/error 정책이 존재할 때)
          - p95 > max_p95_ms 또는 p99 > max_p99_ms → fail
          - error_rate > max_error_rate → fail
    - section: "Judge — perf checks"
      mode: upsert
      content: |
        apps/judge/slo_judge.evaluate():
          - SLO.latency / SLO.error 존재 시 Evidence.perf 필수
          - 위반 사유를 reasons[]에 추가: latency.p95_over, latency.p99_over, error.rate_over
  plan:
    - section: "Milestones — v0.5.11h"
      mode: upsert
      content: |
        - Witness: perf.py + CLI 추가
        - Evidence: perf 블록 병합 지원
        - SLO 스키마/저지: latency/error 정책 추가
        - 샘플 SLO v2 2종 (canary/strict)
        - 테스트: gate_t(1), gate_aj(2), integration(1) Green
    - section: "Next Actions — v0.5.11h"
      mode: upsert
      content: |
        Day 223: perf witness/CLI 구현 및 단위테스트
        Day 224: slo(latency/error) + judge 확장, 통합테스트 및 CI 매트릭스 업데이트
