meta:
  version: v0.5.11q-1
  date: 2025-11-11
  status: locked
  summary: "PR 주석 자동 템플릿 도입 + 아티팩트 링크 유효성 검사 + CI 릴리스 게이트 주석 강화"

patches:
  techspec:
    - section: "CI — PR Comment & Artifacts Validation"
      mode: upsert
      content: |
        - PR 코멘트는 템플릿 기반으로 자동 생성하며, 게이트 상태/주 사유(code+message+count)/아티팩트 링크(Evidence, Gate Reports, Ops Cards)를 포함한다.
        - 모든 외부 링크는 릴리스 게이트 완료 직후 유효성 검사를 통과해야 하며, 2xx/302/304만 허용한다. 실패 시 워크플로 실패(fail-closed).
        - 주석 본문에는 업데이트 식별을 위한 마커 <!--DECISIONOS:PR:RELEASE_GATE--> 를 포함한다.
  plan:
    - section: "Milestones — v0.5.11q-1"
      mode: upsert
      content: |
        Day 1: 템플릿/검증 스크립트 추가, CI 단계 삽입
        Day 2: 게이트 요약(gate_summary.json)·사유(reasons.json)·아티팩트(manifest.json) 연동
        Day 3: PR 코멘트 자동화 E2E 확인 및 문구/형식 튜닝
  ci:
    - section: "Workflow — release_gate steps (추가)"
      mode: upsert
      content: |
        - name: Validate artifact links
          run: |
            python scripts/ci/validate_artifacts.py --manifest var/reports/artifacts-manifest.json
        - name: Compose & post PR comment
          env:
            GITHUB_TOKEN: secrets.GITHUB_TOKEN
          run: |
            python scripts/ci/annotate_release_gate.py \
              --template .github/pr_comment_template.md \
              --status-json var/reports/gate_summary.json \
              --reasons-json var/reports/reasons.json \
              --manifest var/reports/artifacts-manifest.json \
              --out var/reports/pr_comment.md \
              --repo "github.repository" \
              --pr "github.event.pull_request.number"
  ops_docs:
    - section: "Runbooks — Reviewer UX"
      mode: upsert
      content: |
        - PR 코멘트 상단에 Gates 상태(Infra/Canary), 주 사유 Top-N(code→message) 테이블, Evidence/Reports 링크, Run 링크가 노출된다.
        - 링크 검증 실패 시 워크플로가 실패하므로 재시도 전 아티팩트 퍼블릭 접근 권한/서명 URL/보존 기한을 확인한다.

notes:
  apply:
    - "Save files in repo:"
    - "  - .github/pr_comment_template.md"
    - "  - scripts/ci/validate_artifacts.py"
    - "  - scripts/ci/annotate_release_gate.py (v2)"
    - "Update CI: .github/workflows/ci.yml release_gate job"
    - "Run: python scripts/wo_apply.py docs/work_orders/wo-v0.5.11q-1-pr-comment-artifacts.yaml && python scripts/doc_guard.py"
