# DecisionOS Prod Cutover Runbook — v0.5.11q

## Scope
본 런북은 v0.5.11q 기준 "배포 가능 + 카나리 안전장치 + 운영 가시성(Ops API/ETag)" 상태에서 **블루-그린/카나리 컷오버**를 안전하게 수행하기 위한 절차를 정의한다.

## Roles
- **Deploy Owner (DO)**: 최종 승격/중단 승인
- **SRE**: 게이트 실행, 모니터링, 롤백
- **Sec/Key Custodian**: 키 로테이션/KMS 상태 점검

## Key Env/Secrets
- `DECISIONOS_ALLOW_SCOPES` (RBAC; default-deny)  
  예: `ops:read,judge:run,deploy:promote,deploy:abort`
- `DECISIONOS_JUDGE_KEYS` 또는 `DECISIONOS_JUDGE_HMAC_KEY` (멀티키/HMAC)
- (선택) `AWS_REGION`, `DECISIONOS_KMS_PARAM_PATH` (KMS/SSM 로더)
- Evidence 경로: `var/evidence/latest.json`

## Pre-Flight Check (T-24h)
1) **RBAC**: 운영 스코프 최소화 적용 확인  
2) **Keys**: KMS/SSM → ENV 우선순위, active/grace 상태 확인  
3) **Clock**: `jobs/clock_guard.py` 실행 → skew within SLA  
4) **Judge Readiness**: `GET /readyz` = `200 {"status":"ready"}`  
5) **Ops API Cache**: `/ops/cards/reason-trends` ETag 304/200 시나리오 확인  
6) **Evidence 불변성**: Indexer/GC dry-run, ObjectLock 업로드 사전 점검  
7) **Stage 파일 무결성**: HMAC 서명 검증, 손상 시 자동 stable 복구 동작 확인

## Cutover Flow (T-0)
1) **Canary 시작**  
   `pipeline/release/canary_step.sh` 실행 → shadow/mirror 활성  
2) **증빙 수확**  
   - reqlog/judgelog harvest 잡 실행 → `perf`, `perf_judge` 생성/병합  
   - Evidence 최신화 → `var/evidence/latest.json`  
3) **릴리스 게이트(2종)**  
   - Infra SLO: `dosctl judge quorum --slo configs/slo/slo-judge-infra.json --evidence var/evidence/latest.json --quorum 2/3`  
   - Canary SLO: `configs/slo/slo-billing-strict-v2.json` 기준 동일 실행  
4) **자동 승격/중단**  
   - `jobs.canary_auto_promote` (N 회 연속 pass & burst=0 → `promote.sh`)  
   - 위반/스파이크 → `abort_on_gate_fail.sh` → stage=stable  
5) **포스트 검증 (T+2h)**  
   - Ops 대시보드 reason-trends/top-impact 카드 모니터  
   - Evidence `WIP → LOCKED` 전환 및 ObjectLock 업로드 확인

## Go/No-Go 기준
- **GO**: `/readyz` ready, p95/p99 ≤ 정책, error_rate ≤ 정책, canary windows 최근 N회 모두 pass & burst=0, Evidence tampered=false  
- **NO-GO**: samples 부족, p95/p99 초과, error_rate 초과, canary fail/burst, stage 서명 불일치 반복

## Rollback
- 수동: `pipeline/release/abort.sh` (RBAC: `deploy:abort`)  
- 자동: `pipeline/release/abort_on_gate_fail.sh` (게이트 실패 시 즉시 abort)

## 표준 명령 모음
```bash
# Ready
curl -sS http://localhost:8080/readyz | jq .

# Ops Cards (ETag)
curl -i -H 'Authorization: Bearer scope=ops:read' \
  http://localhost:8081/ops/cards/reason-trends

# Evidence 빌드(예시)
python -m jobs.evidence_harvest_reqlog --csv var/log/reqlog.csv --out var/evidence/perf.json
python -m jobs.evidence_harvest_judgelog --csv var/log/judgelog.csv --out var/evidence/perf_judge.json

# Gate
dosctl judge quorum --slo configs/slo/slo-judge-infra.json \
  --evidence var/evidence/latest.json --quorum 2/3
dosctl judge quorum --slo configs/slo/slo-billing-strict-v2.json \
  --evidence var/evidence/latest.json --quorum 2/3

# Promote / Abort
pipeline/release/promote.sh
pipeline/release/abort.sh
```

## 운영 메모

* Stage 토큰은 **atomic+HMAC** 유틸만 사용(직접 echo 금지)
* PR 주석/아티팩트: 게이트 결과 요약, Evidence 링크, top-impact 레이블 포함
* Chaos/DR 리허설: Redis/SQLite 리플레이 스토어 장애, 키 로테이션, 네트워크 지연

---
