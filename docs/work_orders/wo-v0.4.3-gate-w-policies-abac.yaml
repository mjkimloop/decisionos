meta:
  version: v0.4.3
  date: 2025-11-05
  status: locked
  summary: "Gate-W: Policies & ABAC · Data Boundaries · Masking/Tokenization · Residency (No-Gemini)"

patches:
  techspec:
    - section: "Policy Architecture — PDP/PEP & ABAC"
      mode: replace
      content: |
        목적: 모델/벤더 중립의 정책 계층 확립. '기본 거부(deny-by-default)' 원칙.
        구성:
          - PDP(Policy Decision Point): 정책 평가 엔진(abac_eval) — Cedar-like 규칙문법
          - PEP(Policy Enforcement Point): API Gateway/Router/SQL/RPC 미들웨어
          - PAP(Policy Admin Point): 정책 저장소(policy_store), 버전/승인 워크플로
          - PIP(Policy Info Point): 속성 공급자(tenant/org/role, data tags, residency, purpose)
        ABAC 핵심 속성:
          - Subject: role, clearance, skills, org_plan, region, mfa_level
          - Resource: dataset.classification, data.tags[], residency, lineage_path
          - Action: read/write/export/run_decision/admin
          - Context: time, network_zone, evidence_required, purpose(binding)

    - section: "Policy Language — Cedar-lite (v1)"
      mode: replace
      content: |
        문법(요지):
          permit(action, subject, resource)
            when { subject.role in ["owner","admin"] && resource.classification != "PII-S" }
            unless { context.network_zone == "public" && action == "export" }
        기능: allow/deny, 조건식(and/or/not, in), 속성 비교, 리스트 교차, 시간/지역, 목적구속(purpose-binding)
        버전: policy@semver + change log + 서명(hash-chain)

    - section: "Data Boundaries & Residency"
      mode: replace
      content: |
        데이터 경계:
          - 경계 단위: region(KR, JP, EU, US), org boundary, project boundary
          - 카탈로그 태깅: dataset.tags[residency, pii, finance, restricted]
        거주지(Residency):
          - residency=="KR" 데이터는 KR 리전 저장/처리 의무
          - cross-region 전송은 policy 'allow_with_controls' + DPA 레코드 요구
        Export 정책:
          - export는 항상 purpose, ticket_id, retention_days 요구
          - 고위험(restricted, PII-S)은 HITL 승인 + 워터마크 + 만료토큰

    - section: "RLS/CLS · Dynamic Masking · Tokenization"
      mode: replace
      content: |
        DB 보안:
          - RLS(Row-Level Security): org_id, residency, clearance 기준
          - CLS(Column-Level Security): classification별 select 허용/차단
          - Dynamic Masking: 전화/주민번호/계좌 — show_last4(), hash_email()
          - Tokenization: format-preserving token(FPE)로 저장, on-demand detokenize(권한 필요)
        API 계층:
          - 결과셋 후처리 마스킹(PEP) + 감사 라벨(trace_id, policy_id)

    - section: "Consent & Purpose Binding"
      mode: replace
      content: |
        동의/목적 구속:
          - consents{org_id, subject, purpose, scope, valid_until}
          - policy에서 purpose 필수. 미충족 시 deny 또는 HITL 요구
        감사:
          - 모든 허가 결정에 policy_id/consent_id 링크, Evidence Binder(Security)에 보관

    - section: "Marketplace/Ext 연동(게이트-V)"
      mode: replace
      content: |
        확장/플러그인 권한:
          - ext.yaml의 scopes를 정책에 매핑(최소권한)
          - 네트워크 egress는 policy로 제한(allowlist)
          - break-glass: 시간제한 승격(<= 2h), 사후 리뷰·감사필수

    - section: "Interfaces — API/CLI"
      mode: replace
      content: |
        API:
          - POST /api/v1/policies/apply {bundle.tgz}  # 서명·검증, dry-run 옵션
          - GET  /api/v1/policies/eval {subject, action, resource, context}
          - GET  /api/v1/policies/list | GET /api/v1/policies/changes
          - POST /api/v1/policies/approve {policy_id, comment}
          - GET  /api/v1/boundaries/check?dataset=&org_id=
        CLI(dosctl):
          - `dosctl policy init|lint|dryrun|apply|rollback`
          - `dosctl policy eval --subject '{"role":"reviewer"}' --action read --resource dataset://loans`
          - `dosctl boundary check --dataset loans_kr --org 123`

    - section: "Security/Compliance"
      mode: replace
      content: |
        - 기본 거부, 허용은 최소 범위. 모든 예외는 만료/사후감사 필요
        - 정책 번들 서명/검증, 배포 전 dry-run + 영향분석
        - 로그/트레이스에 policy_id, decision, masked_fields 라벨 필수
        - RLS/CLS/Masking 단위 테스트 + 공격 패턴 회귀(예: always-true bypass)
        - 데이터 경계 위반 감지 → 자동 차단 + P0 알림(Gate-T 경로)

    - section: "SLO & Acceptance"
      mode: replace
      content: |
        Gate-W 성공 기준:
          - 정책 평가 p95 ≤ 30ms, API 오버헤드 ≤ 10%
          - 보호 리소스 커버리지 100%(카탈로그 태그 기반 샘플링 검증)
          - 거주지 위반 0, 교차지역 export는 전부 목적구속/승인 로그 보유
          - RLS/CLS/마스킹/토큰화 e2e 테스트 60+ 전부 통과
          - 정책 번들 롤아웃/롤백 e2e + dry-run 영향분석 증빙
          - Evidence Binder(Security/Policy) 업데이트

  plan:
    - section: "Milestones"
      mode: replace
      content: |
        - PDP/PEP/정책저장소·언어(v1) · 정책 번들 서명/배포
        - 카탈로그 태깅 + 경계/거주지 강제 · Export 통제
        - DB RLS/CLS/마스킹/토큰화 · API 후처리 PEP
        - Consent/Purpose Binding · 감사 라벨/리포트
        - 테스트/런북/증빙 번들(보안/정책)
    - section: "Next Actions"
      mode: replace
      content: |
        Day 116: abac_eval(PDP) · cedar-lite parser · policy_store + dosctl policy lint|eval
        Day 117: PEP 미들웨어(API/Gateway/SQL) · deny-by-default 적용 · 오버헤드 측정
        Day 118: 카탈로그 태깅·경계/거주지 검사 · export 통제(목적/티켓/만료토큰)
        Day 119: RLS/CLS/Masking/Tokenization 구현 · 단위/회귀 테스트 60+
        Day 120: Consent/Purpose Binding · 롤아웃/롤백·증빙/런북·SLO 검수

work:
  codex:
    - id: X-104
      title: PDP/Policy Store/Cedar-lite Parser
      deliverables:
        - apps/policy/{pdp.py, parser.py, store.py}
        - tests/policy/{parser_test.py, eval_test.py}
      acceptance:
        - p95 ≤ 30ms, 언어 기능 동작, 단위 테스트 30+
    - id: X-105
      title: PEP Middlewares (API/GW/SQL)
      deliverables:
        - apps/policy/pep/{api.py, gateway.py, sql.py}
        - routers/policies.py (# apply/eval/list/changes/approve)
      acceptance:
        - deny-by-default, 허가 로그 정책 라벨 포함, 회귀 테스트 통과
    - id: X-106
      title: Catalog Tagging & Boundary Enforcement
      deliverables:
        - apps/catalog/tags.py, routers/boundaries.py
      acceptance:
        - residency/export 검사, 위반 차단·알림 e2e
    - id: X-107
      title: RLS/CLS/Masking/Tokenization
      deliverables:
        - db/security/{rls.sql, cls.sql}
        - apps/security/{masking.py, tokenization.py}
      acceptance:
        - 행/열 보안·동적 마스킹·FPE 토큰화 e2e
    - id: X-108
      title: Consent & Purpose Binding
      deliverables:
        - apps/consent/{models.py, service.py}
        - apps/policy/hooks/purpose.py
      acceptance:
        - consent 기반 평가·증빙 링크, export 워크플로 통합
    - id: P-20
      title: dosctl (policy/boundary/consent)
      deliverables:
        - cli/dosctl/main.py: policy init|lint|dryrun|apply|eval|rollback, boundary check, consent ls
      acceptance:
        - 로컬에서 정책 번들 배포/평가/롤백 e2e

risks:
  - name: 정책 누락/과대허용
    mitigation: deny-by-default, dry-run 영향분석, 네거티브 테스트 스위트
  - name: 성능 오버헤드
    mitigation: 캐시·프리디케이트 전개·스냅샷 속성, p95 모니터링(Gate-T 연계)
  - name: 마스킹/토큰화 오탐
    mitigation: 샘플 기반 검증·화이트리스트, 비상 해제(break-glass)·사후감사
  - name: 경계/거주지 위반
    mitigation: 카탈로그 태깅 의무화, export 티켓/만료토큰, 위반시 자동 차단+P0
  - name: 확장(플러그인) 과권한
    mitigation: scope 최소화·권한 린트·카나리·시간제한 승격(<=2h)
